name: Deploy Azure Component
run-name: Deploy ${{ inputs.component }} in ${{ inputs.environment }} environment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'The environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod
        default: 'dev'
      location:
        description: 'The location to deploy to'
        required: true
        type: choice
        options:
          - eastus
          - japaneast
          - centralindia
        default: 'centralindia'
      component:
        description: 'The component to deploy'
        required: true
        type: choice
        options:
          - 02-networking
          - 03-security
          - 04-aks
          - 05-observability
          - 06-cicd
          - 07-idp
        default: '02-networking'

env:
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  # Backend configuration
  TF_STATE_STORAGE_ACCOUNT: ${{ secrets.TF_STATE_STORAGE_ACCOUNT }}
  TF_STATE_RESOURCE_GROUP: ${{ secrets.TF_STATE_RESOURCE_GROUP }}
  # IDP/Backstage configuration
  TF_VAR_db_admin_password: ${{ secrets.BACKSTAGE_DB_PASSWORD }}
  TF_VAR_github_token: ${{ secrets.BACKSTAGE_GITHUB_TOKEN }}
  TF_VAR_github_client_id: ${{ secrets.BACKSTAGE_GITHUB_CLIENT_ID }}
  TF_VAR_github_client_secret: ${{ secrets.BACKSTAGE_GITHUB_CLIENT_SECRET }}

jobs:
  foundation:
    name: Deploy Foundation
    runs-on: ubuntu-latest
    outputs:
      storage_account: ${{ steps.foundation.outputs.storage_account }}
      resource_group: ${{ steps.foundation.outputs.resource_group }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Setup Azure CLI
        uses: azure/login@v1
        with:
          creds: '{"clientId":"${{ secrets.ARM_CLIENT_ID }}","clientSecret":"${{ secrets.ARM_CLIENT_SECRET }}","subscriptionId":"${{ secrets.ARM_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.ARM_TENANT_ID }}"}'

      - name: Check if backend exists
        id: check_backend
        working-directory: terraform/01-foundation
        run: |
          # Check if the storage account exists first
          if az storage account show --name "$TF_STATE_STORAGE_ACCOUNT" --resource-group "$TF_STATE_RESOURCE_GROUP" >/dev/null 2>&1; then
            echo "backend_exists=true" >> $GITHUB_OUTPUT
            echo "Backend storage account exists"
          else
            echo "backend_exists=false" >> $GITHUB_OUTPUT
            echo "Backend storage account doesn't exist, will bootstrap"
          fi

      - name: Bootstrap Foundation (No Backend)
        if: steps.check_backend.outputs.backend_exists == 'false'
        working-directory: terraform/01-foundation
        run: |
          echo "Bootstrapping foundation without backend..."
          terraform init
          terraform apply -auto-approve -var-file=${{ github.event.inputs.environment }}.tfvars
          
          # Get outputs for backend configuration
          STORAGE_ACCOUNT=$(terraform output -raw tfstate_storage_account_name)
          RESOURCE_GROUP=$(terraform output -raw tfstate_resource_group_name)
          
          echo "storage_account=$STORAGE_ACCOUNT" >> $GITHUB_OUTPUT
          echo "resource_group=$RESOURCE_GROUP" >> $GITHUB_OUTPUT
          
          # Display cost monitoring information
          echo "## ðŸ’° Cost Monitoring Configured" >> $GITHUB_STEP_SUMMARY
          echo "- Monthly Budget: \$$(terraform output -raw budget_amount)" >> $GITHUB_STEP_SUMMARY
          echo "- Resource Group: $(terraform output -raw component_resource_group_name)" >> $GITHUB_STEP_SUMMARY
          echo "- Platform Budget ID: $(terraform output -raw platform_budget_id)" >> $GITHUB_STEP_SUMMARY
          
          # Now migrate to remote backend
          echo "Migrating to remote backend..."
          terraform init \
            -backend-config="storage_account_name=$STORAGE_ACCOUNT" \
            -backend-config="container_name=foundation" \
            -backend-config="key=foundation.tfstate" \
            -backend-config="resource_group_name=$RESOURCE_GROUP" \
            -backend-config="use_azuread_auth=true" \
            -migrate-state

      - name: Deploy Foundation (With Backend)
        if: steps.check_backend.outputs.backend_exists == 'true'
        id: foundation
        working-directory: terraform/01-foundation
        run: |
          echo "Deploying foundation with existing backend..."
          terraform init \
            -backend-config="storage_account_name=$TF_STATE_STORAGE_ACCOUNT" \
            -backend-config="container_name=foundation" \
            -backend-config="key=foundation.tfstate" \
            -backend-config="resource_group_name=$TF_STATE_RESOURCE_GROUP" \
            -backend-config="use_azuread_auth=true"
          terraform plan -var-file=${{ github.event.inputs.environment }}.tfvars
          terraform apply -auto-approve -var-file=${{ github.event.inputs.environment }}.tfvars
          echo "Foundation deployment completed successfully"
          
          # Display cost monitoring information
          echo "## ðŸ’° Cost Monitoring Configured" >> $GITHUB_STEP_SUMMARY
          echo "- Monthly Budget: \$$(terraform output -raw budget_amount)" >> $GITHUB_STEP_SUMMARY
          echo "- Resource Group: $(terraform output -raw component_resource_group_name)" >> $GITHUB_STEP_SUMMARY
          echo "- Platform Budget ID: $(terraform output -raw platform_budget_id)" >> $GITHUB_STEP_SUMMARY

  component:
    name: Deploy ${{ github.event.inputs.component }}
    needs: foundation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Setup Azure CLI
        uses: azure/login@v1
        with:
          creds: '{"clientId":"${{ secrets.ARM_CLIENT_ID }}","clientSecret":"${{ secrets.ARM_CLIENT_SECRET }}","subscriptionId":"${{ secrets.ARM_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.ARM_TENANT_ID }}"}'

      - name: Deploy Component
        id: component
        working-directory: terraform/${{ github.event.inputs.component }}
        run: |
          echo "Initializing and deploying ${{ github.event.inputs.component }}..."
          
          # Check if backend.hcl exists for this component, if not create it
          if [ ! -f "backend.hcl" ]; then
            echo "Creating backend.hcl for ${{ github.event.inputs.component }}..."
            cat > backend.hcl << EOF
          container_name       = "${{ github.event.inputs.component }}"
          key                  = "${{ github.event.inputs.component }}.tfstate"
          storage_account_name = "$TF_STATE_STORAGE_ACCOUNT"
          resource_group_name  = "$TF_STATE_RESOURCE_GROUP"
          use_azuread_auth     = true
          EOF
          fi
          
          terraform init -backend-config="backend.hcl"
          terraform plan -var-file=${{ github.event.inputs.environment }}.tfvars
          terraform apply -auto-approve -var-file=${{ github.event.inputs.environment }}.tfvars
          echo "${{ github.event.inputs.component }} deployment completed successfully"
          
          # Display component-specific information
          if [ "${{ github.event.inputs.component }}" = "02-networking" ]; then
            echo "## ðŸŒ Networking Resources Deployed" >> $GITHUB_STEP_SUMMARY
            echo "- VNet Name: $(terraform output -raw vnet_name)" >> $GITHUB_STEP_SUMMARY
            echo "- VNet Address Space: $(terraform output -raw vnet_address_space)" >> $GITHUB_STEP_SUMMARY
            echo "- Resource Group: $(terraform output -raw resource_group_name)" >> $GITHUB_STEP_SUMMARY
            echo "- Public Subnet: $(terraform output -raw public_subnet_name)" >> $GITHUB_STEP_SUMMARY
            echo "- Private Subnet: $(terraform output -raw private_subnet_name)" >> $GITHUB_STEP_SUMMARY
            echo "- AKS Subnet: $(terraform output -raw aks_subnet_name)" >> $GITHUB_STEP_SUMMARY
            echo "- NAT Gateway: $(terraform output -raw nat_gateway_name)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event.inputs.component }}" = "07-idp" ]; then
            echo "## ðŸ—ï¸ Internal Developer Platform Deployed" >> $GITHUB_STEP_SUMMARY
            echo "- Backstage Namespace: backstage" >> $GITHUB_STEP_SUMMARY
            echo "- PostgreSQL Server: $(terraform output -raw postgresql_server_name)" >> $GITHUB_STEP_SUMMARY
            echo "- Azure AD App: $(terraform output -raw application_name)" >> $GITHUB_STEP_SUMMARY
            echo "- Platform Admin Group: $(terraform output -raw admin_group_name)" >> $GITHUB_STEP_SUMMARY
            echo "- Developer Group: $(terraform output -raw developer_group_name)" >> $GITHUB_STEP_SUMMARY
            echo "- Viewer Group: $(terraform output -raw viewer_group_name)" >> $GITHUB_STEP_SUMMARY
          fi